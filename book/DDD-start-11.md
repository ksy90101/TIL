# 11장. CQRS

## 단일 모델의 단점

- 주문 내역 조회시 여러 애그리거트가 필요한데, 이때 조회 속도가 빠를 수록 좋기 때문에 구현 방법에 대해 고민해봐야 한다. ID 참조는 즉시 로딩을 사용할수도 없기 때문에 조회 속도에 문제가 생길수 있다.
- 직접 참조를 해도 고민이 되는것이 조회 화면의 특성에 따라 같은 연관도 즉시 로딩이나 지연 로딩으로 처리해야 한다. JPA 네이티브 쿼리가 필요할 수도 있다.
- 이러한 고민을 왜 할까? 시스템 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문이다.
- 이러한 복잡도를 낮추는 간단한 방법은 상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것이다.

## CQRS

- 시스템이 제공하는 기능은 상태 변경하는 기능과 상태 정보를 조회하는 기능 두가지가 있을 것이다.
- 도메인 모델 관점에서 상태 변경은 주로 한 애그리거트의 상태를 변경하는 것이지만, 조회 기능은 한 애그리거트 데이터만 조회하는 것이 아니라 여러개의 애그리거트를 조회할 수도 있다.
- 이렇게 불일치가 있기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 불필요하게 복잡해진다. 이러한 문제를 해결 할 수 있는 게 바로 CQRS 이다.
- Command Query Responsibility Segregation의 약자로 상태를 변경하는 명령을 위한 모델과 상태를 제공하는 조회를 위한 모델을 분리하는 패턴이다.

![image](https://user-images.githubusercontent.com/53366407/126860432-d35002f0-66ce-4e1c-bd0e-ef96f011e910.png)

- CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다. 예를들어 명령 모델은 객체 지향 기반해서 JPA를, 조회 모델은 MyBatis를 사용할 수 있다.
- 두 데이터 저장소간의 데이터 동기화는 이벤트를 활용하면 된다. 이벤트가 발생하면 조회 모델에 전달해 변경 내역을 반영하면 된다.
- 실시간 데이터 반영에서 다른 DB를 사용한다면 동기 이벤트와 글로벌 트랜잭션을 사용할 수 있지만, 성능 문제가 있다.
- 그러나 특정 시간에만 동기화해야 한다면 비동기 데이터 전송도 가능하다.

### 웹과 CQRS

- 일반적으로 웹은 상태를 조회하는 요청이 많다. 따라서 DB도 조회 전용을 따로 만들어서 성능을 높이기도 한다.

### CQRS의 장단점

- 장점은 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점이다. 또한 조회 성능을 향상시켜준다.
- 단점은 구현해야 할 코드가 너무 많다. 또한 더 많은 구현 기술이 필요하다는 점이다.
- CQRS는 양날의 검이다.
