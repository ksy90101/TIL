# 6장. 응용 서비스와 표현 영역

## 표현 영역과 응용 영역

- 도메인 영역만이 중요한게 아니다. 도메인이 제 기능을 하기위해 도메인을 연결해주는 매개체가 필요하다.
- 바로 그것이 표현 영역과 응용 영역이다.

### 표현 영역

- 사용자의 요청을 해석한다.
- 사용자가 어떤 기능을 실행하는지 판별하고 그 기능을 제공하는 응용 서비스를 실행한다.

### 응용 영역

- 실제 사용자가 원하는 기능을 제공하는 곳
- 사용자와 상호작용은 표현 영역이 처리하기 때문에 응용 서비스는 표현 영역에 의존하지 않는다.

## 응용 서비스의 역할

- 사용자의 요청을 처리하기 위해 리포지터리로부터 도메인 객체를 구하고, 도메인 객체를 사용한다.
- 응용 서비스가 복잡하다면 응용 서비스에서 도메인 로직의 일부를 구현하고 있을 가능성이 높다.
- 응용 서비스의 가장 큰 역할은 도메인 객체 간의 실행 흐름을 제어하는 것과 트랜잭션 처리이다.

### 도메인 로직 넣지 않기

- 도메인 로직을 응용 서비스와 도메인 영역에 분산해서 구현하면 아래와 같은 문제점이 있다.
    1. 코드의 응집성이 떨어진다.
    2. 여러 응용 서비스에서 동일한 도메인 로직을 구현할 가능성이 높아진다. (중복 코드)
    3. 코드 변경이 어려워 진다.

## 응용 서비스의 구현

### 응용 서비스의 크기

- 중복 코드는 private 메서드로 구현하고 이를 호출하는 방법으로 중복코드를 제거할 수 있다.
- 그러나 클래스의 크기가 커질 확률이 높다. 따라서 분리하는 것이 좋다.
- 구분되는 기능별로 서비스 클래스를 구현하는 방식은 한 응용 서비스 클래스에서 1개~3개 기능을 구현하는 것이 좋다.
- 클래스의 갯수가 많아지지만, 모두 구현하는 것과 비교해서 코드 품질은 일정 수준으로 유지하는데 도움이 된다.
- 또한 각 클래스별로 필요한 의존 객체만 포함하므로 다른 기능을 구현한 코드에 영향을 받지 않는다.

### 응용 서비스의 인터페이스와 클래스

- 인터페이스가 필요한 경우는 구현 클래스가 여러개인 경우다.
- 그러나 구현 클래스가 두 개인 경우가 매우 드물다. 따라서 소스 파일만 많아지고 구현 클래스에 대한 간접 참조가 증가해 전체 구조만 복잡해지는 문제가 발생한다.

### 메서드 파라미터와 값 리턴

- 응용 서비스가 제공하는 메서드는 도메인을 이용해서 사용자가 요구한 기능을 실행하는 데 필요한 값을 파라미터를 통해 전달받아야 한다.
- DTO를 사용해 파라미터를 받고 값을 리턴하는 것이 좋다.
- 아울러 애그리거트 객체를 그대로 리턴할 수 있다. 그때는 표현 영역에서 사용자에게 보여줄 응답 화면을 생성하면 된다.
- 그러나 도메인의 로직 실행을 응용 서비스와 표현 영역 두곳에서 할 수 있게 되므로 응집도가 낮추는 원인이 된다. 따라서 표현 영역에서 필요한 데이터만 응용 서비스가 리턴해주는 것이 좋다.

### 표현 영역에 의존하지 않기

- 응용 서비스의 파라미터 타입을 결정할 때 표현 영역과 관련된 타입을 사용하면 안된다. 즉, HttpServletRequest나 HttpSession을 응용 서비스에 파라미터로 전달하면 안된다.
- 응용 서비스에서 표현 영역의 의존이 발생하면 테스트하기가 어려워 진다. 또한 표현 영역 구현이 변경되면 응용 서비스의 구현도 함께 변경해야 하는 문제가 발생한다.
- 또한, 응용 서비스가 표현 영역이 해야하는 책임을 대신 하는 경우가 발생한다.
- 즉, 응집도가 깨지게 되고 코드 유지보수 비용을 증가시킨다.

### 트랜잭션 처리

- 프레임워크가 제공하는 트랜잭션 기능을 적극적으로 사용하자.

### 도메인 이벤트 처리

- 도메인이 발생시킨 이벤트를 처리하는 것도 응용 서비스의 중요한 역할이다.
- 이벤트를 사용하면 코드가 다소 복잡해지지만, 도메인 간의 의존성이나 외부 시스템에 대한 의존을 낮춰주는 장점을 얻을 수 있다.
- 또한 시스템을 확장하는 데 이벤트가 핵심 역할을 수행하게 된다.

## 표현 영역

![image](https://user-images.githubusercontent.com/53366407/126035527-8624c870-26f2-45aa-b90c-07793bea9dc4.png)

- 책임은 아래와 같다.
    1. 사용자가 시스템을 사용할 수 있는 흐름을 제공하고 제어한다.
    2. 사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다.
    3. 사용자의 세션을 관리한다.

## 값 검증

- 값 검증은 표현 영역과 응용 서비스 두 곳에서 모두 수행이 가능하다.
- 원칙적으로 모든 값에 대한 검증은 응용 서비스에서 처리한다.
- 근데, 표현 영역에서 잘못된 값이 존재하면 이를 사용자에게 알려줘서 다시 값을 받아야 한다.
- 응용 서비스에서 각 값이 존재하는지 형식이 올바른지 확인할 목적으로 익셉션을 사용하면 사용자에게 좋지 않은 경험을 제공하게 될수 있다. 이런 경우에는 표현 영역에서 값을 검사하면 된다.
- 스프링같은 경우는 Validator 인터페이스를 따로 제공해주기 때문에 이 인터페이스를 구현한 검증기를 따로 구현하면 간결해질 수 있다.

## 권한 검사

- 보안 프레임워크의 복잡도를 떠나 보통 다음의 세 곳에서 권한 검사를 수행할 수 있다.
    - 표현 영역
    - 응용 서비스
    - 도메인
- 표현 영역에서는 인증된 사용자인지 아닌지 여부이다.
    - 이러한 접근 제어하기 가장 좋은 위치가 서블릿 필터이다.
- URL 만으로 접근 제어를 하지 못한다면 응용 서비스의 메서드 단위로 권한 검사를 하는 것이다. 더 좋은 방법은 AOP를 이용해 애노테이션으로 서비스 메서드에 대한 권한 검사를 하는 것이다.
- 개별 도메인 단위는 직접 불러와야 할때 사용한다.

## 조회 전용 기능과 응용 서비스

- 조회 전용 기능만 있다면 표현 영역에서 트랜잭션이 필요없기 때문에 구현해도 된다.
