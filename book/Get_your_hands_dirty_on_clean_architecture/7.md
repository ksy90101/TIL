# 7. ì•„í‚¤í…ì²˜ ìš”ì†Œ í…ŒìŠ¤íŠ¸í•˜ê¸°

## í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ

> ë¹„ìš©ì´ ë§ì´ ë“œëŠ” í…ŒìŠ¤íŠ¸ëŠ” ì§€ì–‘í•˜ê³  ë¹„ìš©ì´ ì ê²Œ ë“œëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë§ì´ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ë§Œë“œëŠ” ë¹„ìš©ì´ ì ê³ , ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì‰½ê³ , ë¹¨ë¦¬ ì‹¤í–‰ë˜ê³ , ì•ˆì •ì ì¸ ì‘ì€ í¬ê¸°ì˜ í…ŒìŠ¤íŠ¸ë“¤ì— ëŒ€í•´ ë†’ì€ ì»¤ë²„ë¦¬ì§€ë¥¼ ìœ ì§€í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
> 

![image](https://user-images.githubusercontent.com/53366407/151956954-e053763a-383b-4b87-b613-e93e4155bdc0.png)

<aside>
ğŸ’¡ ì¢‹ì€ í…ŒìŠ¤íŠ¸ì˜ ì†ì„±(FIRST)
F(Fast) : ë¹ ë¥´ê²Œ ë™ì‘í•´ë¼.
I(Isolated) : ê³ ë¦½ì‹œì¼œë¼.
R(Repeatable): ë°˜ë³µ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.
S(Self-validating) : ìŠ¤ìŠ¤ë¡œ ê²€ì¦ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.
T(Timely): ì ì‹œì— ì‚¬ìš©í•´ì•¼ í•œë‹¤.

</aside>

- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(Unit)
    - í•˜ë‚˜ì˜ í´ë˜ìŠ¤ë¥¼ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ê³  í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ê¸°ëŠ¥ë“¤ì„ í…ŒìŠ¤íŠ¸í•œë‹¤.
    - í…ŒìŠ¤íŠ¸ ì¤‘ì¸ í´ë˜ìŠ¤ê°€ ë‹¤ë¥¸ í´ë˜ìŠ¤ì— ì˜ì¡´í•œë‹¤ë©´ ì˜ì¡´ë˜ëŠ” í´ë˜ìŠ¤ë“¤ì€ mockìœ¼ë¡œ ëŒ€ì²´í•œë‹¤.
- í†µí•©í…ŒìŠ¤íŠ¸(Integration)
    - ì—°ê²°ëœ ì—¬ëŸ¬ ìœ ë‹›ì„ ì¸ìŠ¤í„´ìŠ¤í™”í•˜ê³  ì‹œì‘ì ì´ ë˜ëŠ” í´ë˜ìŠ¤ì˜ ì¸í„°í˜ì´ìŠ¤ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¸ í›„ ìœ ë‹›ë“¤ì˜ ë„¤íŠ¸ì›Œí¬ê°€ ê¸°ëŒ€í•œ ëŒ€ë¡œ ì˜ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦í•œë‹¤.
- )ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸(E2E)
    - ëª¨ë“  ê°ì²´ ë„¤íŠ¸ì›Œí¬ë¥¼ ê°€ë™ì‹œì¼œ íŠ¹ì • ìœ ìŠ¤ì¼€ì´ìŠ¤ê°€ ì „ ê³„ì¸µì—ì„œ ì˜ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦

## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ë„ë©”ì¸ ì—”í‹°í‹° í…ŒìŠ¤íŠ¸í•˜ê¸°

```java
package com.book.cleanarchitecture.buckpal.account.domain;

import com.book.cleanarchitecture.buckpal.account.domain.vo.AccountId;
import com.book.cleanarchitecture.buckpal.account.domain.vo.Money;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static com.book.cleanarchitecture.buckpal.common.AccountTestData.defaultAccount;
import static com.book.cleanarchitecture.buckpal.common.ActivityTestData.defaultActivity;
import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertAll;

class AccountTest {

    private final AccountId accountId = new AccountId(1L);
    private final Account account = defaultAccount()
            .withAccountId(accountId)
            .withBaselineBalance(Money.of(555L))
            .withActivityWindow(new ActivityWindow(
                    defaultActivity()
                            .withTargetAccount(accountId)
                            .withMoney(Money.of(999L)).build(),
                    defaultActivity()
                            .withTargetAccount(accountId)
                            .withMoney(Money.of(1L)).build()))
            .build();

    @Test
    @DisplayName("ê³„ì¢Œì˜ ê¸ˆì•¡ ê³„ì‚°í•˜ëŠ” ë©”ì„œë“œ")
    void calculateBalance() {
        Money balance = account.calculateBalance();

        assertThat(balance).isEqualTo(Money.of(1555L));
    }

    @Test
    @DisplayName("ê³„ì¢Œ ì†¡ê¸ˆ ì„±ê³µ í…ŒìŠ¤íŠ¸")
    void withdrawalSucceeds() {
        boolean success = account.withdraw(Money.of(555L), new AccountId(99L));

        assertAll(
                () -> assertThat(success).isTrue(),
                () -> assertThat(account.getActivities()).hasSize(3),
                () -> assertThat(account.calculateBalance()).isEqualTo(Money.of(1000L))
        );
    }

    @Test
    @DisplayName("ê³„ì¢Œ ì†¡ê¸ˆ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ (ì´ˆê³¼ëœ ê¸ˆì•¡)")
    void withdrawalFailure() {
        boolean failure = account.withdraw(Money.of(1556L), new AccountId(99L));

        assertAll(
                () -> assertThat(failure).isFalse(),
                () -> assertThat(account.getActivities()).hasSize(2),
                () -> assertThat(account.calculateBalance()).isEqualTo(Money.of(1555L))
        );
    }

    @Test
    @DisplayName("ê³„ì¢Œ ì˜ˆê¸ˆ ì„±ê³µ í…ŒìŠ¤íŠ¸")
    void depositSuccess() {
        boolean success = account.deposit(Money.of(445L), new AccountId(99L));

        assertAll(
                () -> assertThat(success).isTrue(),
                () -> assertThat(account.getActivities()).hasSize(3),
                () -> assertThat(account.calculateBalance()).isEqualTo(Money.of(2000L))
        );
    }
}
```

## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ìœ ìŠ¤ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸í•˜ê¸°

```java
package com.book.cleanarchitecture.buckpal.account.application.service;

import com.book.cleanarchitecture.buckpal.account.application.port.in.SendMoneyCommand;
import com.book.cleanarchitecture.buckpal.account.application.port.out.AccountLock;
import com.book.cleanarchitecture.buckpal.account.application.port.out.LoadAccountPort;
import com.book.cleanarchitecture.buckpal.account.application.port.out.UpdateAccountStatePort;
import com.book.cleanarchitecture.buckpal.account.domain.Account;
import com.book.cleanarchitecture.buckpal.account.domain.vo.AccountId;
import com.book.cleanarchitecture.buckpal.account.domain.vo.Money;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.BDDMockito.given;
import static org.mockito.BDDMockito.then;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.times;

class SendMoneyServiceTest {
    private final LoadAccountPort loadAccountPort = mock(LoadAccountPort.class);
    private final AccountLock accountLock = mock(AccountLock.class);
    private final UpdateAccountStatePort updateAccountStatePort = mock(UpdateAccountStatePort.class);
    private final SendMoneyService sendMoneyService = new SendMoneyService(loadAccountPort, accountLock, updateAccountStatePort, moneyTransferProperties());

    @Test
    @DisplayName("ê³„ì¢Œ ì†¡ê¸ˆ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸")
    void givenWithdrawalFails_thenOnlySourceAccountIsLockedAndReleased() {
        AccountId sourceAccountId = new AccountId(41L);
        Account sourceAccount = givenAnAccountWithId(sourceAccountId);

        AccountId targetAccountId = new AccountId(42L);
        Account targetAccount = givenAnAccountWithId(targetAccountId);

        givenWithdrawalWillFail(sourceAccount);
        givenDepositWillSucceed(targetAccount);

        SendMoneyCommand command = new SendMoneyCommand(sourceAccountId, targetAccountId, Money.of(300L));

        boolean success = sendMoneyService.sendMoney(command);

        assertThat(success).isFalse();

        then(accountLock).should().lockAccount(eq(sourceAccountId));
        then(accountLock).should().releaseAccount(eq(sourceAccountId));
        then(accountLock).should(times(0)).lockAccount(eq(targetAccountId));
    }

    @Test
    @DisplayName("ê³„ì¢Œì†¡ê¸ˆ ì„±ê³µ í…ŒìŠ¤íŠ¸")
    void transactionSucceeds() {
        Account sourceAccount = givenSourceAccount();
        Account targetAccount = givenTargetAccount();

        givenWithdrawalWillSucceed(sourceAccount);
        givenDepositWillSucceed(targetAccount);

        Money money = Money.of(500L);

        SendMoneyCommand command = new SendMoneyCommand(
                sourceAccount.getId().get(),
                targetAccount.getId().get(),
                money);

        boolean success = sendMoneyService.sendMoney(command);

        assertThat(success).isTrue();

        AccountId sourceAccountId = sourceAccount.getId().get();
        AccountId targetAccountId = targetAccount.getId().get();

        then(accountLock).should().lockAccount(eq(sourceAccountId));
        then(sourceAccount).should().withdraw(eq(money), eq(targetAccountId));
        then(accountLock).should().releaseAccount(eq(sourceAccountId));

        then(accountLock).should().lockAccount(eq(targetAccountId));
        then(targetAccount).should().deposit(eq(money), eq(sourceAccountId));
        then(accountLock).should().releaseAccount(eq(targetAccountId));

        thenAccountsHaveBeenUpdated(sourceAccountId, targetAccountId);
    }

    private void thenAccountsHaveBeenUpdated(AccountId... accountIds) {
        ArgumentCaptor<Account> accountCaptor = ArgumentCaptor.forClass(Account.class);
        then(updateAccountStatePort).should(times(accountIds.length))
                .updateActivities(accountCaptor.capture());

        List<AccountId> updatedAccountIds = accountCaptor.getAllValues()
                .stream()
                .map(Account::getId)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .collect(Collectors.toList());

        for (AccountId accountId : accountIds) {
            assertThat(updatedAccountIds).contains(accountId);
        }
    }

    private void givenDepositWillSucceed(Account account) {
        given(account.deposit(any(Money.class), any(AccountId.class))).willReturn(true);
    }

    private void givenWithdrawalWillFail(Account account) {
        given(account.withdraw(any(Money.class), any(AccountId.class))).willReturn(false);
    }

    private void givenWithdrawalWillSucceed(Account account) {
        given(account.withdraw(any(Money.class), any(AccountId.class))).willReturn(true);
    }

    private Account givenTargetAccount() {
        return givenAnAccountWithId(new AccountId(42L));
    }

    private Account givenSourceAccount() {
        return givenAnAccountWithId(new AccountId(41L));
    }

    private Account givenAnAccountWithId(AccountId id) {
        Account account = mock(Account.class);

        given(account.getId())
                .willReturn(Optional.of(id));
        given(loadAccountPort.loadAccount(eq(account.getId().get()), any(LocalDateTime.class)))
                .willReturn(account);

        return account;
    }

    private MoneyTransferProperties moneyTransferProperties() {
        return new MoneyTransferProperties(Money.of(Long.MAX_VALUE));
    }
}
```

- í…ŒìŠ¤íŠ¸ ì¤‘ì¸ ìœ ìŠ¤ì¼€ì´ìŠ¤ ì„œë¹„ìŠ¤ëŠ” ìƒíƒœê°€ ì—†ê¸° ë•Œë¬¸ì— then ì„¹ì…˜ì—ì„œ íŠ¹ì • ìƒíƒœë¥¼ ê²€ì¦í•  ìˆ˜ ì—†ë‹¤. ëŒ€ì‹  í…ŒìŠ¤íŠ¸ëŠ” ì„œë¹„ìŠ¤ê°€ (ëª¨í‚¹ëœ) ì˜ì¡´ ëŒ€ìƒì˜ íŠ¹ì • ë©”ì„œë“œì™€ ìƒí˜¸ì‘ìš©í–ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²€ì¦í•œë‹¤. ì´ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì½”ë“œì˜ í–‰ë™ ë³€ê²½ë¿ë§Œ ì•„ë‹ˆë¼ ì½”ë“œì˜ êµ¬ì¡° ë³€ê²½ì—ë„ ì·¨ì•½í•´ì§„ë‹¤ëŠ” ì˜ë¯¸ê°€ ëœë‹¤. ìì—°ìŠ¤ëŸ½ê²Œ ì½”ë“œê°€ ë¦¬íŒ©í„°ë§ë˜ë©´ í…ŒìŠ¤íŠ¸ë„ ë³€ê²½ë  í™•ë¥ ì´ ë†’ì•„ì§„ë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì—, í…ŒìŠ¤íŠ¸ì—ì„œ ì–´ë–¤ ìƒí˜¸ì‘ìš©ì„ ê²€ì¦í•˜ê³  ì‹¶ì€ì§€ ì‹ ì¤‘í•˜ê²Œ ìƒê°í•´ì•¼ í•œë‹¤. ì•ì˜ ì˜ˆì œì²˜ëŸ¼ ëª¨ë“  ë™ì‘ì„ ê²€ì¦í•˜ëŠ” ëŒ€ì‹  ì¤‘ìš”í•œ í•µì‹¬ë§Œ ê³¨ë¼ ì§‘ì¤‘í•´ì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ì¢‹ë‹¤. ë§Œì•½ ëª¨ë“  ë™ì‘ì„ ê²€ì¦í•˜ë ¤ê³  í•˜ë©´ í´ë˜ìŠ¤ê°€ ì¡°ê¸ˆì´ë¼ë„ ë°”ë€” ë•Œë§ˆë‹¤ í…ŒìŠ¤íŠ¸ë¥¼ ë³€ê²½í•´ì•¼ í•œë‹¤. ì´ëŠ” í…ŒìŠ¤íŠ¸ì˜ ê°€ì¹˜ë¥¼ ë–¨ì–´ëœ¨ë¦¬ëŠ” ì¼ì´ë‹¤.

## í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì›¹ ì–´ëŒ‘í„° í…ŒìŠ¤íŠ¸í•˜ê¸°

```java
package com.book.cleanarchitecture.buckpal.account.adapter.in.web;

import com.book.cleanarchitecture.buckpal.account.application.port.in.SendMoneyCommand;
import com.book.cleanarchitecture.buckpal.account.application.port.in.SendMoneyUseCase;
import com.book.cleanarchitecture.buckpal.account.domain.vo.AccountId;
import com.book.cleanarchitecture.buckpal.account.domain.vo.Money;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.web.servlet.MockMvc;

import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.BDDMockito.then;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@WebMvcTest(controllers = SendMoneyController.class)
class SendMoneyControllerTest {
    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private SendMoneyUseCase sendMoneyUseCase;

    @Test
    @DisplayName("ì†¡ê¸ˆ í…ŒìŠ¤íŠ¸")
    void testSendMoney() throws Exception {
        mockMvc.perform(post("/accounts/send/{sourceAccountId}/{targetAccountId}/{amount}", 41L, 42L, 500)
                        .header("Content-Type", "application/json"))
                .andExpect(status().isOk());

        then(sendMoneyUseCase)
                .should()
                .sendMoney(eq(new SendMoneyCommand(new AccountId(41L), new AccountId(42L), Money.of(500L))));
    }
}
```

- ì›¹ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì— ê°•í•˜ê²Œ ë¬¶ì—¬ ìˆê¸° ë•Œë¬¸ì— ê²©ë¦¬ëœ ìƒíƒœë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°ë³´ë‹¤ëŠ” ì´ í”„ë ˆì„ì›Œí¬ì™€ í†µí•©ëœ ìƒíƒœë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ í•©ë¦¬ì ì´ë‹¤.

## í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì˜ì†ì„± ì–´ëŒ‘í„° í…ŒìŠ¤íŠ¸í•˜ê¸°

```tsx
INSERT INTO accounts (id)
VALUES (1);
INSERT INTO accounts (id)
VALUES (2);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1, '2018-08-08 08:00:00.0', 1, 1, 2, 500);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (2, '2018-08-08 08:00:00.0', 2, 1, 2, 500);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (3, '2018-08-09 10:00:00.0', 1, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (4, '2018-08-09 10:00:00.0', 2, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (5, '2019-08-09 09:00:00.0', 1, 1, 2, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (6, '2019-08-09 09:00:00.0', 2, 1, 2, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (7, '2019-08-09 10:00:00.0', 1, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (8, '2019-08-09 10:00:00.0', 2, 2, 1, 1000);
```

```java
package com.book.cleanarchitecture.buckpal.account.adapter.out.persistence;

import com.book.cleanarchitecture.buckpal.account.domain.Account;
import com.book.cleanarchitecture.buckpal.account.domain.ActivityWindow;
import com.book.cleanarchitecture.buckpal.account.domain.vo.AccountId;
import com.book.cleanarchitecture.buckpal.account.domain.vo.Money;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.jdbc.Sql;

import java.time.LocalDateTime;

import static com.book.cleanarchitecture.buckpal.common.AccountTestData.defaultAccount;
import static com.book.cleanarchitecture.buckpal.common.ActivityTestData.defaultActivity;
import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertAll;

@DataJpaTest
@Import({AccountPersistenceAdapter.class, AccountMapper.class})
class AccountPersistenceAdapterTest {
    @Autowired
    private AccountPersistenceAdapter adapterUnderTest;

    @Autowired
    private ActivityRepository activityRepository;

    @Test
    @Sql("AccountPersistenceAdapterTest.sql")
    void loadsAccount() {
        Account account = adapterUnderTest.loadAccount(new AccountId(1L), LocalDateTime.of(2018, 8, 10, 0, 0));

        assertAll(
                () -> assertThat(account.getActivities()).hasSize(2),
                () -> assertThat(account.calculateBalance()).isEqualTo(Money.of(500))
        );
    }

    @Test
    void updatesActivities() {
        Account account = defaultAccount()
                .withBaselineBalance(Money.of(555L))
                .withActivityWindow(new ActivityWindow(
                        defaultActivity()
                                .withId(null)
                                .withMoney(Money.of(1L)).build()))
                .build();

        adapterUnderTest.updateActivities(account);
        
        ActivityJpaEntity savedActivity = activityRepository.findAll().get(0);

        assertAll(
                () -> assertThat(activityRepository.count()).isEqualTo(1),
                () -> assertThat(savedActivity.getAmount()).isEqualTo(1L)
        );
    }
}
```

- ë”ë¯¸ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ í•˜ëŠ” ê²ƒì´ ë” íš¨ìœ¨ì ì´ë‹¤.

## ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ë¡œ ì£¼ìš” ê²½ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸°

```tsx
INSERT INTO accounts (id)
VALUES (1);
INSERT INTO accounts (id)
VALUES (2);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1001, '2018-08-08 08:00:00.0', 1, 1, 2, 500);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1002, '2018-08-08 08:00:00.0', 2, 1, 2, 500);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1003, '2018-08-09 10:00:00.0', 1, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1004, '2018-08-09 10:00:00.0', 2, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1005, '2019-08-09 09:00:00.0', 1, 1, 2, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1006, '2019-08-09 09:00:00.0', 2, 1, 2, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1007, '2019-08-09 10:00:00.0', 1, 2, 1, 1000);

INSERT INTO activities (id, timestamp, owner_account_id, source_account_id, target_account_id, amount)
VALUES (1008, '2019-08-09 10:00:00.0', 2, 2, 1, 1000);
```

```java
package com.book.cleanarchitecture.buckpal;

import com.book.cleanarchitecture.buckpal.account.application.port.out.LoadAccountPort;
import com.book.cleanarchitecture.buckpal.account.domain.Account;
import com.book.cleanarchitecture.buckpal.account.domain.vo.AccountId;
import com.book.cleanarchitecture.buckpal.account.domain.vo.Money;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.*;
import org.springframework.test.context.jdbc.Sql;

import java.time.LocalDateTime;

import static org.assertj.core.api.BDDAssertions.then;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class SendMoneySystemTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private LoadAccountPort loadAccountPort;

    @Test
    @Sql("SendMoneySystemTest.sql")
    void sendMoney() {
        Money initialSourceBalance = sourceAccount().calculateBalance();
        Money initialTargetBalance = targetAccount().calculateBalance();
        ResponseEntity<Object> response = whenSendMoney(sourceAccountId(), targetAccountId(), transferredAmount());

        then(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        then(sourceAccount().calculateBalance()).isEqualTo(initialSourceBalance.minus(transferredAmount()));
        then(targetAccount().calculateBalance()).isEqualTo(initialTargetBalance.plus(transferredAmount()));
    }

    private Account sourceAccount() {
        return loadAccount(sourceAccountId());
    }

    private Account targetAccount() {
        return loadAccount(targetAccountId());
    }

    private Account loadAccount(AccountId accountId) {
        return loadAccountPort.loadAccount(accountId, LocalDateTime.now());
    }

    private ResponseEntity<Object> whenSendMoney(AccountId sourceAccountId, AccountId targetAccountId, Money amount) {
        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Type", "application/json");
        HttpEntity<Void> request = new HttpEntity<>(null, headers);

        return restTemplate.exchange(
                "/accounts/send/{sourceAccountId}/{targetAccountId}/{amount}",
                HttpMethod.POST,
                request,
                Object.class,
                sourceAccountId.getValue(),
                targetAccountId.getValue(),
                amount.getAmount());
    }

    private Money transferredAmount() {
        return Money.of(500L);
    }

    private AccountId sourceAccountId() {
        return new AccountId(1L);
    }

    private AccountId targetAccountId() {
        return new AccountId(2L);
    }
}
```

- ì¼ë°˜ì ìœ¼ë¡œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸ê°€ ë°œê²¬í•˜ëŠ” ë²„ê·¸ì™€ëŠ” ë˜ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ë²„ê·¸ë¥¼ ë°œê²¬í•´ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë‚˜ í†µí•© í…ŒìŠ¤íŠ¸ë§Œìœ¼ë¡œëŠ” ì•Œì•„ì°¨ë¦¬ì§€ ëª»í–ˆì„ ê³„ì¸µ ê°„ ë§¤í•‘ ë²„ê·¸ ê°™ì€ ê²ƒë“¤ ë§ì´ë‹¤.
- ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ëŠ” ì—¬ëŸ¬ ê°œì˜ ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ ê²°í•©í•´ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë§Œë“¤ ë•Œ ë” ë¹›ì´ ë‚œë‹¤. ê° ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ì„œ ê±°ì³ê°ˆ íŠ¹ì • ê²½ë¡œë¥¼ ì˜ë¯¸í•œë‹¤. ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì¤‘ìš”í•œ ì‹œë‚˜ë¦¬ì˜¤ë“¤ì´ ì»¤ë²„ëœë‹¤ë©´ ìµœì‹  ë³€ê²½ì‚¬í•­ë“¤ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§ê°€ëœ¨ë¦¬ì§€ ì•Šì•˜ìŒì„ ê°€ì •í•  ìˆ˜ ìˆê³ , ë°°í¬ë  ì¤€ë¹„ê°€ ëë‹¤ëŠ” í™•ì‹ ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.

## ì–¼ë§ˆë§Œì˜ í…ŒìŠ¤íŠ¸ê°€ ì¶©ë¶„í• ê¹Œ?

- ë¼ì¸ ì»¤ë²„ë¦¬ì§€ëŠ” í…ŒìŠ¤íŠ¸ ì„±ê³µì„ ì¸¡ì •í•˜ëŠ” ë° ìˆì–´ì„œëŠ” ì˜ëª»ëœ ì§€í‘œë‹¤.
- í”„ë¡œë•ì…˜ì˜ ë²„ê·¸ë¥¼ ìˆ˜ì •í•˜ê³  ì´ë¡œë¶€í„° ë°°ìš°ëŠ” ê²ƒì„ ìš°ì„ ìˆœìœ„ë¡œ ì‚¼ìœ¼ë©´ ì œëŒ€ë¡œ ê°€ê³  ìˆëŠ” ê²ƒì´ë‹¤.
- ë„ë©”ì¸ ì—”í‹°í‹°ë¥¼ êµ¬í˜„í•  ë•ŒëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ì»¤ë²„í•˜ì.
- ìœ ìŠ¤ì¼€ì´ìŠ¤ë¥¼ êµ¬í˜„í•  ë–„ëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ì»¤ë²„í•˜ì.
- ì–´ëŒ‘í„°ë¥¼ êµ¬í˜„í•  ë•ŒëŠ” í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì»¤ë²„í•˜ì.
- ì‚¬ìš©ìê°€ ì·¨í•  ìˆ˜ ìˆëŠ” ì¤‘ìš” ì• í”Œë¦¬ì¼€ì´ì…˜ ê²½ë¡œëŠ” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ë¡œ ì»¤ë²„í•˜ì.

## ì¶œì²˜

- [ë§Œë“¤ë©´ì„œ ë°°ìš°ëŠ” í´ë¦° ì•„í‚¤í…ì²˜ - ìë°” ì½”ë“œë¡œ êµ¬í˜„í•˜ëŠ” í´ë¦° ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜](https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=283437942)
